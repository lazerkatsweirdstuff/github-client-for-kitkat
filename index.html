<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KitKat GitHub Client</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 10px;
            background-color: #f5f5f5;
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .container {
            background-color: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 15px;
        }
        input, textarea, button, select {
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 3px;
            width: 100%;
            box-sizing: border-box;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            margin-right: 5px;
            margin-bottom: 5px;
        }
        button:disabled {
            background-color: #cccccc;
        }
        button.danger {
            background-color: #d73a49;
        }
        button.secondary {
            background-color: #6c757d;
        }
        button.info {
            background-color: #0366d6;
        }
        button.download {
            background-color: #6f42c1;
        }
        .repo-item, .file-item, .collab-item, .release-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        .repo-item:last-child, .file-item:last-child, .collab-item:last-child, .release-item:last-child {
            border-bottom: none;
        }
        .repo-name, .file-name, .collab-name, .release-name {
            font-weight: bold;
            color: #0366d6;
        }
        .repo-desc, .file-content, .collab-role, .release-desc {
            color: #666;
            font-size: 0.9em;
        }
        .error {
            color: #d73a49;
            font-weight: bold;
        }
        .success {
            color: #28a745;
            font-weight: bold;
        }
        .loading {
            text-align: center;
            color: #666;
        }
        .auth-section, .repo-section {
            display: none;
        }
        .tabs {
            display: flex;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .tab {
            padding: 10px 15px;
            background-color: #eee;
            cursor: pointer;
            margin-right: 5px;
            margin-bottom: 5px;
        }
        .tab.active {
            background-color: white;
            font-weight: bold;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .file-actions, .repo-actions {
            margin-top: 10px;
        }
        .file-content-editor {
            width: 100%;
            min-height: 200px;
            font-family: monospace;
        }
        .breadcrumb {
            margin-bottom: 10px;
        }
        .breadcrumb a {
            color: #0366d6;
            text-decoration: none;
        }
        .markdown-preview {
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 3px;
            background-color: white;
        }
        .markdown-preview img {
            max-width: 100%;
        }
        .markdown-preview em {
            font-style: italic;
        }
        .image-preview {
            max-width: 100%;
            margin: 10px 0;
        }
        .collab-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-right: 10px;
            vertical-align: middle;
        }
        .release-asset {
            font-size: 0.8em;
            margin-left: 20px;
            color: #586069;
        }
        .file-download-link {
            display: inline-block;
            margin-top: 5px;
            color: #0366d6;
            text-decoration: none;
        }
    </style>
</head>
<body>
    <h1>KitKat GitHub Client</h1>
    
    <div class="container" id="authContainer">
        <h2>Authentication</h2>
        <div>
            <p>Note: For security, use a personal access token (PAT) with repo scope.</p>
            <input type="text" id="username" placeholder="GitHub username" />
            <input type="password" id="token" placeholder="Personal Access Token" />
            <button id="loginBtn">Login</button>
            <div id="authStatus"></div>
        </div>
    </div>
    
    <div class="container auth-section" id="userContainer">
        <h2>Welcome, <span id="userName"></span></h2>
        <button id="logoutBtn" class="danger">Logout</button>
    </div>
    
    <div class="container auth-section" id="reposContainer">
        <div class="tabs">
            <div class="tab active" data-tab="repos">My Repositories</div>
            <div class="tab" data-tab="create">Create Repository</div>
            <div class="tab" data-tab="search">Search Users/Repos</div>
        </div>
        
        <div class="tab-content active" id="repos-tab">
            <button id="refreshReposBtn">Refresh Repositories</button>
            <div id="reposList"></div>
        </div>
        
        <div class="tab-content" id="create-tab">
            <input type="text" id="newRepoName" placeholder="Repository name" />
            <textarea id="newRepoDesc" placeholder="Description"></textarea>
            <select id="newRepoVisibility">
                <option value="public">Public</option>
                <option value="private">Private</option>
            </select>
            <button id="createRepoBtn">Create Repository</button>
            <div id="createRepoStatus"></div>
        </div>
        
        <div class="tab-content" id="search-tab">
            <input type="text" id="searchQuery" placeholder="Username or repo (user/repo)" />
            <button id="searchUserBtn">Search Users</button>
            <button id="searchRepoBtn">Search Repos</button>
            <div id="searchResults"></div>
        </div>
    </div>
    
    <div class="container auth-section" id="repoEditContainer" style="display: none;">
        <div class="breadcrumb" id="repoBreadcrumb"></div>
        <h2>Repository: <span id="editRepoName"></span></h2>
        
        <div class="tabs">
            <div class="tab active" data-tab="repo-info">Repository Info</div>
            <div class="tab" data-tab="repo-files">Files</div>
            <div class="tab" data-tab="repo-collabs">Collaborators</div>
            <div class="tab" data-tab="repo-releases">Releases</div>
        </div>
        
        <div class="tab-content active" id="repo-info-tab">
            <textarea id="editRepoDesc" placeholder="Description"></textarea>
            <div class="repo-actions">
                <button id="updateRepoBtn">Update Repository</button>
                <button id="deleteRepoBtn" class="danger">Delete Repository</button>
                <button id="backToReposBtn">Back to Repositories</button>
            </div>
            <div id="repoEditStatus"></div>
        </div>
        
        <div class="tab-content" id="repo-files-tab">
            <div id="fileBrowser"></div>
            <div id="fileEditor" style="display: none;">
                <textarea id="fileContentEditor" class="file-content-editor"></textarea>
                <div id="markdownPreview" class="markdown-preview" style="display: none;"></div>
                <div id="imagePreview" style="display: none;">
                    <img id="imagePreviewImg" class="image-preview" />
                    <a id="downloadImageBtn" href="#" class="file-download-link" download>Download Image</a>
                </div>
                <div id="fileDownload" style="display: none;">
                    <a id="downloadFileBtn" href="#" class="file-download-link" download>Download File</a>
                </div>
                <div class="file-actions">
                    <button id="saveFileBtn">Save File</button>
                    <button id="renameFileBtn" class="info">Rename File</button>
                    <button id="cancelEditFileBtn" class="secondary">Cancel</button>
                    <button id="deleteFileBtn" class="danger">Delete File</button>
                    <button id="downloadBtn" class="download">Download</button>
                </div>
                <div id="fileEditStatus"></div>
            </div>
            <div id="fileCreate" style="display: none;">
                <input type="text" id="newFileName" placeholder="File path (e.g., folder/file.txt)" />
                <textarea id="newFileContent" class="file-content-editor" placeholder="File content"></textarea>
                <div class="file-actions">
                    <button id="createFileBtn">Create File</button>
                    <button id="cancelCreateFileBtn" class="secondary">Cancel</button>
                </div>
                <div id="fileCreateStatus"></div>
            </div>
            <div id="fileRename" style="display: none;">
                <input type="text" id="renameFilePath" placeholder="New file path" />
                <div class="file-actions">
                    <button id="confirmRenameFileBtn">Rename File</button>
                    <button id="cancelRenameFileBtn" class="secondary">Cancel</button>
                </div>
                <div id="fileRenameStatus"></div>
            </div>
            <div class="file-actions">
                <button id="newFileBtn">New File</button>
                <button id="refreshFilesBtn">Refresh Files</button>
                <button id="backToReposFromFilesBtn">Back to Repositories</button>
            </div>
        </div>
        
        <div class="tab-content" id="repo-collabs-tab">
            <div id="collabsList"></div>
            <div class="file-actions">
                <button id="refreshCollabsBtn">Refresh Collaborators</button>
                <button id="backToReposFromCollabsBtn">Back to Repositories</button>
            </div>
        </div>
        
        <div class="tab-content" id="repo-releases-tab">
            <div id="releasesList"></div>
            <div class="file-actions">
                <button id="refreshReleasesBtn">Refresh Releases</button>
                <button id="backToReposFromReleasesBtn">Back to Repositories</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        var authToken = null;
        var currentUser = null;
        var currentRepo = null;
        var currentPath = '';
        var currentFile = null;
        var currentFileSha = null;
        var isViewingExternalRepo = false;
        var currentDownloadUrl = null;
        
        document.addEventListener('DOMContentLoaded', function() {
            // DOM elements
            var loginBtn = document.getElementById('loginBtn');
            var logoutBtn = document.getElementById('logoutBtn');
            var usernameInput = document.getElementById('username');
            var tokenInput = document.getElementById('token');
            var authStatus = document.getElementById('authStatus');
            var userContainer = document.getElementById('userContainer');
            var reposContainer = document.getElementById('reposContainer');
            var userNameSpan = document.getElementById('userName');
            var reposList = document.getElementById('reposList');
            var refreshReposBtn = document.getElementById('refreshReposBtn');
            var createRepoBtn = document.getElementById('createRepoBtn');
            var newRepoName = document.getElementById('newRepoName');
            var newRepoDesc = document.getElementById('newRepoDesc');
            var newRepoVisibility = document.getElementById('newRepoVisibility');
            var createRepoStatus = document.getElementById('createRepoStatus');
            var searchUserBtn = document.getElementById('searchUserBtn');
            var searchRepoBtn = document.getElementById('searchRepoBtn');
            var searchQuery = document.getElementById('searchQuery');
            var searchResults = document.getElementById('searchResults');
            var repoEditContainer = document.getElementById('repoEditContainer');
            var editRepoName = document.getElementById('editRepoName');
            var editRepoDesc = document.getElementById('editRepoDesc');
            var updateRepoBtn = document.getElementById('updateRepoBtn');
            var deleteRepoBtn = document.getElementById('deleteRepoBtn');
            var backToReposBtn = document.getElementById('backToReposBtn');
            var repoEditStatus = document.getElementById('repoEditStatus');
            var repoBreadcrumb = document.getElementById('repoBreadcrumb');
            var fileBrowser = document.getElementById('fileBrowser');
            var fileEditor = document.getElementById('fileEditor');
            var fileContentEditor = document.getElementById('fileContentEditor');
            var markdownPreview = document.getElementById('markdownPreview');
            var imagePreview = document.getElementById('imagePreview');
            var imagePreviewImg = document.getElementById('imagePreviewImg');
            var downloadImageBtn = document.getElementById('downloadImageBtn');
            var fileDownload = document.getElementById('fileDownload');
            var downloadFileBtn = document.getElementById('downloadFileBtn');
            var saveFileBtn = document.getElementById('saveFileBtn');
            var renameFileBtn = document.getElementById('renameFileBtn');
            var cancelEditFileBtn = document.getElementById('cancelEditFileBtn');
            var deleteFileBtn = document.getElementById('deleteFileBtn');
            var downloadBtn = document.getElementById('downloadBtn');
            var fileEditStatus = document.getElementById('fileEditStatus');
            var fileCreate = document.getElementById('fileCreate');
            var newFileName = document.getElementById('newFileName');
            var newFileContent = document.getElementById('newFileContent');
            var createFileBtn = document.getElementById('createFileBtn');
            var cancelCreateFileBtn = document.getElementById('cancelCreateFileBtn');
            var fileCreateStatus = document.getElementById('fileCreateStatus');
            var fileRename = document.getElementById('fileRename');
            var renameFilePath = document.getElementById('renameFilePath');
            var confirmRenameFileBtn = document.getElementById('confirmRenameFileBtn');
            var cancelRenameFileBtn = document.getElementById('cancelRenameFileBtn');
            var fileRenameStatus = document.getElementById('fileRenameStatus');
            var newFileBtn = document.getElementById('newFileBtn');
            var refreshFilesBtn = document.getElementById('refreshFilesBtn');
            var backToReposFromFilesBtn = document.getElementById('backToReposFromFilesBtn');
            var collabsList = document.getElementById('collabsList');
            var refreshCollabsBtn = document.getElementById('refreshCollabsBtn');
            var backToReposFromCollabsBtn = document.getElementById('backToReposFromCollabsBtn');
            var releasesList = document.getElementById('releasesList');
            var refreshReleasesBtn = document.getElementById('refreshReleasesBtn');
            var backToReposFromReleasesBtn = document.getElementById('backToReposFromReleasesBtn');
            
            // Tab switching
            function setupTabs(container) {
                var tabs = container.querySelectorAll('.tab');
                tabs.forEach(function(tab) {
                    tab.addEventListener('click', function() {
                        // Remove active class from all tabs and contents in this container
                        container.querySelectorAll('.tab').forEach(function(t) {
                            t.classList.remove('active');
                        });
                        container.querySelectorAll('.tab-content').forEach(function(c) {
                            c.classList.remove('active');
                        });
                        
                        // Add active class to clicked tab and corresponding content
                        this.classList.add('active');
                        document.getElementById(this.getAttribute('data-tab') + '-tab').classList.add('active');
                    });
                });
            }
            
            setupTabs(reposContainer);
            setupTabs(repoEditContainer);
            
            // Event listeners
            loginBtn.addEventListener('click', login);
            logoutBtn.addEventListener('click', logout);
            refreshReposBtn.addEventListener('click', loadRepositories);
            createRepoBtn.addEventListener('click', createRepository);
            searchUserBtn.addEventListener('click', function() { searchGitHub('users'); });
            searchRepoBtn.addEventListener('click', function() { searchGitHub('repos'); });
            updateRepoBtn.addEventListener('click', updateRepository);
            deleteRepoBtn.addEventListener('click', deleteRepository);
            backToReposBtn.addEventListener('click', backToRepositories);
            
            newFileBtn.addEventListener('click', function() {
                fileBrowser.style.display = 'none';
                fileEditor.style.display = 'none';
                fileCreate.style.display = 'block';
                fileRename.style.display = 'none';
                newFileName.value = '';
                newFileContent.value = '';
                fileCreateStatus.innerHTML = '';
            });
            
            refreshFilesBtn.addEventListener('click', function() {
                browseFiles(currentPath);
            });
            
            saveFileBtn.addEventListener('click', saveFile);
            renameFileBtn.addEventListener('click', showRenameFile);
            cancelEditFileBtn.addEventListener('click', cancelEditFile);
            deleteFileBtn.addEventListener('click', deleteFile);
            downloadBtn.addEventListener('click', downloadCurrentFile);
            createFileBtn.addEventListener('click', createFile);
            cancelCreateFileBtn.addEventListener('click', cancelCreateFile);
            confirmRenameFileBtn.addEventListener('click', renameFile);
            cancelRenameFileBtn.addEventListener('click', cancelRenameFile);
            backToReposFromFilesBtn.addEventListener('click', backToRepositories);
            refreshCollabsBtn.addEventListener('click', loadCollaborators);
            backToReposFromCollabsBtn.addEventListener('click', backToRepositories);
            refreshReleasesBtn.addEventListener('click', loadReleases);
            backToReposFromReleasesBtn.addEventListener('click', backToRepositories);
            
            // Check if already logged in (from sessionStorage)
            if (sessionStorage.getItem('githubToken')) {
                authToken = sessionStorage.getItem('githubToken');
                currentUser = sessionStorage.getItem('githubUser');
                showAuthenticatedUI();
                loadUserDetails();
                loadRepositories();
            }
            
            function login() {
                var username = usernameInput.value.trim();
                var token = tokenInput.value.trim();
                
                if (!username || !token) {
                    authStatus.innerHTML = '<div class="error">Please enter both username and token</div>';
                    return;
                }
                
                authToken = token;
                currentUser = username;
                
                // Verify credentials by fetching user details
                githubRequest('GET', 'https://api.github.com/user', null, function(response) {
                    // Success - save to session storage
                    sessionStorage.setItem('githubToken', authToken);
                    sessionStorage.setItem('githubUser', currentUser);
                    
                    showAuthenticatedUI();
                    loadUserDetails();
                    loadRepositories();
                    
                    authStatus.innerHTML = '<div class="success">Login successful!</div>';
                }, function(error) {
                    authToken = null;
                    currentUser = null;
                    authStatus.innerHTML = '<div class="error">Login failed: ' + (error.message || 'Invalid credentials') + '</div>';
                });
            }
            
            function logout() {
                authToken = null;
                currentUser = null;
                sessionStorage.removeItem('githubToken');
                sessionStorage.removeItem('githubUser');
                
                document.querySelectorAll('.auth-section').forEach(function(el) {
                    el.style.display = 'none';
                });
                document.getElementById('authContainer').style.display = 'block';
                usernameInput.value = '';
                tokenInput.value = '';
                authStatus.innerHTML = '<div class="success">Logged out successfully</div>';
            }
            
            function showAuthenticatedUI() {
                document.getElementById('authContainer').style.display = 'none';
                document.querySelectorAll('.auth-section').forEach(function(el) {
                    el.style.display = 'block';
                });
                userNameSpan.textContent = currentUser;
            }
            
            function loadUserDetails() {
                githubRequest('GET', 'https://api.github.com/user', null, function(user) {
                    userNameSpan.textContent = user.login || currentUser;
                }, function(error) {
                    console.error('Failed to load user details:', error);
                });
            }
            
            function loadRepositories() {
                reposList.innerHTML = '<div class="loading">Loading repositories...</div>';
                
                githubRequest('GET', 'https://api.github.com/user/repos?sort=updated', null, function(repos) {
                    if (repos.length === 0) {
                        reposList.innerHTML = '<div>No repositories found.</div>';
                        return;
                    }
                    
                    var html = '';
                    repos.forEach(function(repo) {
                        html += '<div class="repo-item">' +
                                '<div class="repo-name"><a href="javascript:void(0)" onclick="editRepository(\'' + repo.owner.login + '\', \'' + repo.name + '\', false)">' + repo.name + '</a></div>' +
                                '<div class="repo-desc">' + (repo.description || 'No description') + '</div>' +
                                '<div>Stars: ' + repo.stargazers_count + ' | Forks: ' + repo.forks_count + ' | ' + 
                                (repo.private ? 'Private' : 'Public') + '</div>' +
                                '</div>';
                    });
                    
                    reposList.innerHTML = html;
                }, function(error) {
                    reposList.innerHTML = '<div class="error">Failed to load repositories: ' + (error.message || 'Unknown error') + '</div>';
                });
            }
            
            function createRepository() {
                var name = newRepoName.value.trim();
                var description = newRepoDesc.value.trim();
                var isPrivate = newRepoVisibility.value === 'private';
                
                if (!name) {
                    createRepoStatus.innerHTML = '<div class="error">Repository name is required</div>';
                    return;
                }
                
                var data = {
                    name: name,
                    description: description,
                    private: isPrivate,
                    auto_init: true
                };
                
                createRepoStatus.innerHTML = '<div class="loading">Creating repository...</div>';
                
                githubRequest('POST', 'https://api.github.com/user/repos', data, function(repo) {
                    createRepoStatus.innerHTML = '<div class="success">Repository created successfully! <a href="' + repo.html_url + '" target="_blank">View on GitHub</a></div>';
                    newRepoName.value = '';
                    newRepoDesc.value = '';
                    loadRepositories();
                }, function(error) {
                    createRepoStatus.innerHTML = '<div class="error">Failed to create repository: ' + (error.message || 'Unknown error') + '</div>';
                });
            }
            
            function searchGitHub(type) {
                var query = searchQuery.value.trim();
                
                if (!query) {
                    searchResults.innerHTML = '<div class="error">Please enter a search query</div>';
                    return;
                }
                
                searchResults.innerHTML = '<div class="loading">Searching...</div>';
                
                var url = type === 'users' ? 
                    'https://api.github.com/search/users?q=' + encodeURIComponent(query) :
                    'https://api.github.com/search/repositories?q=' + encodeURIComponent(query);
                
                githubRequest('GET', url, null, function(result) {
                    if (result.items.length === 0) {
                        searchResults.innerHTML = '<div>No results found.</div>';
                        return;
                    }
                    
                    var html = '';
                    if (type === 'users') {
                        html = '<h3>Users</h3>';
                        result.items.forEach(function(user) {
                            html += '<div class="repo-item">' +
                                    '<img src="' + user.avatar_url + '" width="50" style="border-radius:50%; vertical-align:middle; margin-right:10px;">' +
                                    '<div style="display:inline-block; vertical-align:middle;">' +
                                    '<div class="repo-name"><a href="javascript:void(0)" onclick="viewUserRepos(\'' + user.login + '\')">' + user.login + '</a></div>' +
                                    '</div>' +
                                    '</div>';
                        });
                    } else {
                        html = '<h3>Repositories</h3>';
                        result.items.forEach(function(repo) {
                            html += '<div class="repo-item">' +
                                    '<div class="repo-name"><a href="javascript:void(0)" onclick="editRepository(\'' + repo.owner.login + '\', \'' + repo.name + '\', true)">' + repo.full_name + '</a></div>' +
                                    '<div class="repo-desc">' + (repo.description || 'No description') + '</div>' +
                                    '<div>Stars: ' + repo.stargazers_count + ' | Forks: ' + repo.forks_count + ' | ' + 
                                    (repo.private ? 'Private' : 'Public') + '</div>' +
                                    '</div>';
                        });
                    }
                    
                    searchResults.innerHTML = html;
                }, function(error) {
                    searchResults.innerHTML = '<div class="error">Search failed: ' + (error.message || 'Unknown error') + '</div>';
                });
            }
            
            function editRepository(owner, repoName, isExternal) {
                currentRepo = { owner: owner, name: repoName };
                currentPath = '';
                isViewingExternalRepo = isExternal;
                
                githubRequest('GET', 'https://api.github.com/repos/' + owner + '/' + repoName, null, function(repo) {
                    editRepoName.textContent = repoName;
                    editRepoDesc.value = repo.description || '';
                    
                    // Set up breadcrumb
                    updateBreadcrumb();
                    
                    // Load root directory
                    browseFiles('');
                    
                    // Hide management tabs if viewing external repo
                    if (isExternal) {
                        document.querySelectorAll('[data-tab="repo-info"], [data-tab="repo-collabs"]').forEach(function(tab) {
                            tab.style.display = 'none';
                        });
                    } else {
                        document.querySelectorAll('[data-tab="repo-info"], [data-tab="repo-collabs"]').forEach(function(tab) {
                            tab.style.display = 'block';
                        });
                    }
                    
                    // Load collaborators if not external
                    if (!isExternal) {
                        loadCollaborators();
                    }
                    
                    // Load releases
                    loadReleases();
                    
                    reposContainer.style.display = 'none';
                    repoEditContainer.style.display = 'block';
                    repoEditStatus.innerHTML = '';
                }, function(error) {
                    repoEditStatus.innerHTML = '<div class="error">Failed to load repository details</div>';
                });
            }
            
            function updateRepository() {
                if (!currentRepo) return;
                
                var newDescription = editRepoDesc.value.trim();
                
                var data = {
                    name: currentRepo.name,
                    description: newDescription,
                    private: false
                };
                
                repoEditStatus.innerHTML = '<div class="loading">Updating repository...</div>';
                
                githubRequest('PATCH', 'https://api.github.com/repos/' + currentRepo.owner + '/' + currentRepo.name, data, function(repo) {
                    repoEditStatus.innerHTML = '<div class="success">Repository updated successfully!</div>';
                    loadRepositories();
                }, function(error) {
                    repoEditStatus.innerHTML = '<div class="error">Failed to update repository: ' + (error.message || 'Unknown error') + 
                                              (error.errors ? ' - ' + JSON.stringify(error.errors) : '') + '</div>';
                });
            }
            
            function deleteRepository() {
                if (!currentRepo) return;
                
                if (!confirm('Are you sure you want to delete this repository? This action cannot be undone.')) {
                    return;
                }
                
                repoEditStatus.innerHTML = '<div class="loading">Deleting repository...</div>';
                
                githubRequest('DELETE', 'https://api.github.com/repos/' + currentRepo.owner + '/' + currentRepo.name, null, function() {
                    repoEditStatus.innerHTML = '<div class="success">Repository deleted successfully!</div>';
                    setTimeout(function() {
                        backToRepositories();
                    }, 1500);
                }, function(error) {
                    repoEditStatus.innerHTML = '<div class="error">Failed to delete repository: ' + (error.message || 'Unknown error') + '</div>';
                });
            }
            
            function browseFiles(path) {
                fileBrowser.innerHTML = '<div class="loading">Loading files...</div>';
                
                githubRequest('GET', 'https://api.github.com/repos/' + currentRepo.owner + '/' + currentRepo.name + '/contents/' + path, null, function(contents) {
                    if (!Array.isArray(contents)) {
                        contents = [contents];
                    }
                    
                    var html = '';
                    
                    // Add parent directory link if not at root
                    if (path) {
                        var parentPath = path.split('/').slice(0, -1).join('/');
                        html += '<div class="file-item">' +
                                '<div class="file-name"><a href="javascript:void(0)" onclick="browseFiles(\'' + parentPath + '\')">../</a></div>' +
                                '<div class="file-content">Parent directory</div>' +
                                '</div>';
                    }
                    
                    contents.forEach(function(item) {
                        if (item.type === 'dir') {
                            html += '<div class="file-item">' +
                                    '<div class="file-name"><a href="javascript:void(0)" onclick="browseFiles(\'' + (path ? path + '/' : '') + item.name + '\')">' + item.name + '/</a></div>' +
                                    '<div class="file-content">Directory</div>' +
                                    '</div>';
                        } else {
                            html += '<div class="file-item">' +
                                    '<div class="file-name"><a href="javascript:void(0)" onclick="viewFile(\'' + (path ? path + '/' : '') + item.name + '\', \'' + item.sha + '\')">' + item.name + '</a></div>' +
                                    '<div class="file-content">' + (item.size ? (item.size + ' bytes') : 'File') + '</div>' +
                                    '</div>';
                        }
                    });
                    
                    fileBrowser.innerHTML = html;
                    fileBrowser.style.display = 'block';
                    fileEditor.style.display = 'none';
                    fileCreate.style.display = 'none';
                    fileRename.style.display = 'none';
                    
                    // Update current path and breadcrumb
                    currentPath = path;
                    updateBreadcrumb();
                }, function(error) {
                    fileBrowser.innerHTML = '<div class="error">Failed to load files: ' + (error.message || 'Unknown error') + '</div>';
                });
            }
            
            function viewFile(path, sha) {
                currentFile = path;
                currentFileSha = sha;
                
                githubRequest('GET', 'https://api.github.com/repos/' + currentRepo.owner + '/' + currentRepo.name + '/contents/' + path, null, function(file) {
                    // Decode base64 content
                    var content = atob(file.content.replace(/\s/g, ''));
                    
                    // Set download URL
                    currentDownloadUrl = file.download_url;
                    downloadImageBtn.href = file.download_url;
                    downloadImageBtn.download = path.split('/').pop();
                    downloadFileBtn.href = file.download_url;
                    downloadFileBtn.download = path.split('/').pop();
                    
                    // Check file type
                    var isImage = /\.(jpg|jpeg|png|gif|bmp)$/i.test(path);
                    var isMarkdown = /\.md$/i.test(path);
                    
                    if (isImage) {
                        // Display image
                        fileContentEditor.style.display = 'none';
                        markdownPreview.style.display = 'none';
                        imagePreview.style.display = 'block';
                        fileDownload.style.display = 'none';
                        imagePreviewImg.src = file.download_url;
                    } else if (isMarkdown) {
                        // Display markdown with preview
                        fileContentEditor.style.display = 'block';
                        markdownPreview.style.display = 'block';
                        imagePreview.style.display = 'none';
                        fileDownload.style.display = 'none';
                        fileContentEditor.value = content;
                        renderMarkdownPreview(content);
                    } else {
                        // Display regular file
                        fileContentEditor.style.display = 'block';
                        markdownPreview.style.display = 'none';
                        imagePreview.style.display = 'none';
                        fileDownload.style.display = 'block';
                        fileContentEditor.value = content;
                    }
                    
                    // Show/hide edit buttons based on whether it's an external repo
                    if (isViewingExternalRepo) {
                        saveFileBtn.style.display = 'none';
                        renameFileBtn.style.display = 'none';
                        deleteFileBtn.style.display = 'none';
                        downloadBtn.style.display = 'inline-block';
                    } else {
                        saveFileBtn.style.display = 'inline-block';
                        renameFileBtn.style.display = 'inline-block';
                        deleteFileBtn.style.display = 'inline-block';
                        downloadBtn.style.display = 'inline-block';
                    }
                    
                    fileBrowser.style.display = 'none';
                    fileEditor.style.display = 'block';
                    fileCreate.style.display = 'none';
                    fileRename.style.display = 'none';
                    fileEditStatus.innerHTML = '';
                }, function(error) {
                    fileEditStatus.innerHTML = '<div class="error">Failed to load file: ' + (error.message || 'Unknown error') + '</div>';
                });
            }
            
            function renderMarkdownPreview(content) {
                // Simple markdown rendering (basic replacements)
                var html = content
                    .replace(/^# (.*$)/gm, '<h1>$1</h1>')
                    .replace(/^## (.*$)/gm, '<h2>$1</h2>')
                    .replace(/^### (.*$)/gm, '<h3>$1</h3>')
                    .replace(/\!\[(.*?)\]\((.*?)\)/g, '<img src="$2" alt="$1">')
                    .replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2">$1</a>')
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/_([^_]+)_/g, '<em>$1</em>')  // Added for _italic_ support
                    .replace(/`(.*?)`/g, '<code>$1</code>')
                    .replace(/\n\n/g, '<br><br>');
                
                markdownPreview.innerHTML = html;
            }
            
            function downloadCurrentFile() {
                if (!currentDownloadUrl) return;
                
                // Create a temporary anchor element to trigger download
                var a = document.createElement('a');
                a.href = currentDownloadUrl;
                a.download = currentFile.split('/').pop();
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            }
            
            function saveFile() {
                if (!currentFile || !currentFileSha) return;
                
                var newContent = fileContentEditor.value;
                var encodedContent = btoa(newContent);
                
                var data = {
                    message: 'Update ' + currentFile,
                    content: encodedContent,
                    sha: currentFileSha
                };
                
                fileEditStatus.innerHTML = '<div class="loading">Saving file...</div>';
                
                githubRequest('PUT', 'https://api.github.com/repos/' + currentRepo.owner + '/' + currentRepo.name + '/contents/' + currentFile, data, function() {
                    fileEditStatus.innerHTML = '<div class="success">File saved successfully!</div>';
                    setTimeout(function() {
                        browseFiles(currentPath);
                    }, 1000);
                }, function(error) {
                    fileEditStatus.innerHTML = '<div class="error">Failed to save file: ' + (error.message || 'Unknown error') + '</div>';
                });
            }
            
            function showRenameFile() {
                if (!currentFile) return;
                
                fileEditor.style.display = 'none';
                fileRename.style.display = 'block';
                renameFilePath.value = currentFile;
                fileRenameStatus.innerHTML = '';
            }
            
            function renameFile() {
                if (!currentFile || !currentFileSha) return;
                
                var newPath = renameFilePath.value.trim();
                
                if (!newPath) {
                    fileRenameStatus.innerHTML = '<div class="error">New file path is required</div>';
                    return;
                }
                
                if (newPath === currentFile) {
                    cancelRenameFile();
                    return;
                }
                
                // Get current file content
                githubRequest('GET', 'https://api.github.com/repos/' + currentRepo.owner + '/' + currentRepo.name + '/contents/' + currentFile, null, function(file) {
                    var content = file.content;
                    
                    // Create new file
                    var createData = {
                        message: 'Rename ' + currentFile + ' to ' + newPath,
                        content: content
                    };
                    
                    fileRenameStatus.innerHTML = '<div class="loading">Creating new file...</div>';
                    
                    githubRequest('PUT', 'https://api.github.com/repos/' + currentRepo.owner + '/' + currentRepo.name + '/contents/' + newPath, createData, function() {
                        // Delete old file
                        var deleteData = {
                            message: 'Remove ' + currentFile + ' after rename',
                            sha: currentFileSha
                        };
                        
                        githubRequest('DELETE', 'https://api.github.com/repos/' + currentRepo.owner + '/' + currentRepo.name + '/contents/' + currentFile, deleteData, function() {
                            fileRenameStatus.innerHTML = '<div class="success">File renamed successfully!</div>';
                            setTimeout(function() {
                                browseFiles(currentPath);
                            }, 1000);
                        }, function(error) {
                            fileRenameStatus.innerHTML = '<div class="error">File renamed but failed to delete old file: ' + (error.message || 'Unknown error') + '</div>';
                        });
                    }, function(error) {
                        fileRenameStatus.innerHTML = '<div class="error">Failed to create new file: ' + (error.message || 'Unknown error') + '</div>';
                    });
                }, function(error) {
                    fileRenameStatus.innerHTML = '<div class="error">Failed to get file content: ' + (error.message || 'Unknown error') + '</div>';
                });
            }
            
            function cancelRenameFile() {
                fileRename.style.display = 'none';
                fileEditor.style.display = 'block';
            }
            
            function cancelEditFile() {
                browseFiles(currentPath);
            }
            
            function deleteFile() {
                if (!currentFile || !currentFileSha) return;
                
                if (!confirm('Are you sure you want to delete this file?')) {
                    return;
                }
                
                var data = {
                    message: 'Delete ' + currentFile,
                    sha: currentFileSha
                };
                
                fileEditStatus.innerHTML = '<div class="loading">Deleting file...</div>';
                
                githubRequest('DELETE', 'https://api.github.com/repos/' + currentRepo.owner + '/' + currentRepo.name + '/contents/' + currentFile, data, function() {
                    fileEditStatus.innerHTML = '<div class="success">File deleted successfully!</div>';
                    setTimeout(function() {
                        browseFiles(currentPath);
                    }, 1000);
                }, function(error) {
                    fileEditStatus.innerHTML = '<div class="error">Failed to delete file: ' + (error.message || 'Unknown error') + '</div>';
                });
            }
            
            function createFile() {
                var path = newFileName.value.trim();
                var content = newFileContent.value;
                
                if (!path) {
                    fileCreateStatus.innerHTML = '<div class="error">File path is required</div>';
                    return;
                }
                
                var encodedContent = btoa(content);
                
                var data = {
                    message: 'Create ' + path,
                    content: encodedContent
                };
                
                fileCreateStatus.innerHTML = '<div class="loading">Creating file...</div>';
                
                githubRequest('PUT', 'https://api.github.com/repos/' + currentRepo.owner + '/' + currentRepo.name + '/contents/' + path, data, function() {
                    fileCreateStatus.innerHTML = '<div class="success">File created successfully!</div>';
                    setTimeout(function() {
                        browseFiles(currentPath);
                    }, 1000);
                }, function(error) {
                    fileCreateStatus.innerHTML = '<div class="error">Failed to create file: ' + (error.message || 'Unknown error') + '</div>';
                });
            }
            
            function cancelCreateFile() {
                browseFiles(currentPath);
            }
            
            function loadCollaborators() {
                collabsList.innerHTML = '<div class="loading">Loading collaborators...</div>';
                
                githubRequest('GET', 'https://api.github.com/repos/' + currentRepo.owner + '/' + currentRepo.name + '/collaborators', null, function(collaborators) {
                    if (collaborators.length === 0) {
                        collabsList.innerHTML = '<div>No collaborators found for this repository.</div>';
                        return;
                    }
                    
                    var html = '<h3>Collaborators</h3>';
                    collaborators.forEach(function(collab) {
                        html += '<div class="collab-item">' +
                                '<img src="' + collab.avatar_url + '" class="collab-avatar">' +
                                '<div style="display:inline-block; vertical-align:middle;">' +
                                '<div class="collab-name">' + collab.login + '</div>' +
                                '<div class="collab-role">Permissions: ' + (collab.permissions.admin ? 'Admin' : 
                                    (collab.permissions.push ? 'Write' : 'Read')) + '</div>' +
                                '</div>' +
                                '</div>';
                    });
                    
                    collabsList.innerHTML = html;
                }, function(error) {
                    collabsList.innerHTML = '<div class="error">Failed to load collaborators: ' + (error.message || 'Unknown error') + '</div>';
                });
            }
            
            function loadReleases() {
                releasesList.innerHTML = '<div class="loading">Loading releases...</div>';
                
                githubRequest('GET', 'https://api.github.com/repos/' + currentRepo.owner + '/' + currentRepo.name + '/releases', null, function(releases) {
                    if (releases.length === 0) {
                        releasesList.innerHTML = '<div>No releases found for this repository.</div>';
                        return;
                    }
                    
                    var html = '<h3>Releases</h3>';
                    releases.forEach(function(release) {
                        html += '<div class="release-item">' +
                                '<div class="release-name">' + release.name + ' <small>(' + release.tag_name + ')</small></div>' +
                                '<div class="release-desc">' + (release.body || 'No description') + '</div>' +
                                '<div>Published: ' + new Date(release.published_at).toLocaleString() + '</div>';
                        
                        if (release.assets && release.assets.length > 0) {
                            html += '<div><strong>Assets:</strong></div>';
                            release.assets.forEach(function(asset) {
                                html += '<div class="release-asset">' +
                                        '<a href="' + asset.browser_download_url + '" target="_blank">' + asset.name + '</a> (' + 
                                        formatFileSize(asset.size) + ')' +
                                        '</div>';
                            });
                        }
                        
                        html += '</div>';
                    });
                    
                    releasesList.innerHTML = html;
                }, function(error) {
                    releasesList.innerHTML = '<div class="error">Failed to load releases: ' + (error.message || 'Unknown error') + '</div>';
                });
            }
            
            function formatFileSize(bytes) {
                if (bytes < 1024) return bytes + ' bytes';
                else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
                else return (bytes / 1048576).toFixed(1) + ' MB';
            }
            
            function updateBreadcrumb() {
                var parts = currentPath.split('/');
                var breadcrumb = '<a href="javascript:void(0)" onclick="browseFiles(\'\')">' + currentRepo.name + '</a>';
                
                var currentPathPart = '';
                parts.forEach(function(part, index) {
                    if (part) {
                        currentPathPart += (currentPathPart ? '/' : '') + part;
                        breadcrumb += ' / <a href="javascript:void(0)" onclick="browseFiles(\'' + currentPathPart + '\')">' + part + '</a>';
                    }
                });
                
                repoBreadcrumb.innerHTML = breadcrumb;
            }
            
            function backToRepositories() {
                repoEditContainer.style.display = 'none';
                reposContainer.style.display = 'block';
                currentRepo = null;
                currentPath = '';
                currentFile = null;
                currentFileSha = null;
                isViewingExternalRepo = false;
            }
            
            // Make GitHub API requests
            function githubRequest(method, url, data, successCallback, errorCallback) {
                var xhr = new XMLHttpRequest();
                xhr.open(method, url);
                xhr.setRequestHeader('Accept', 'application/vnd.github.v3+json');
                
                if (authToken) {
                    xhr.setRequestHeader('Authorization', 'token ' + authToken);
                }
                
                xhr.onload = function() {
                    if (xhr.status >= 200 && xhr.status < 300) {
                        var response = xhr.responseText ? JSON.parse(xhr.responseText) : null;
                        if (successCallback) successCallback(response);
                    } else {
                        var error = xhr.responseText ? JSON.parse(xhr.responseText) : { message: 'HTTP error ' + xhr.status };
                        if (errorCallback) errorCallback(error);
                    }
                };
                
                xhr.onerror = function() {
                    if (errorCallback) errorCallback({ message: 'Network error' });
                };
                
                if (data) {
                    xhr.setRequestHeader('Content-Type', 'application/json');
                    xhr.send(JSON.stringify(data));
                } else {
                    xhr.send();
                }
            }
            
            // Make functions available globally for button onclick handlers
            window.editRepository = editRepository;
            window.browseFiles = browseFiles;
            window.viewFile = viewFile;
            window.viewUserRepos = function(username) {
                searchResults.innerHTML = '<div class="loading">Loading repositories...</div>';
                
                githubRequest('GET', 'https://api.github.com/users/' + encodeURIComponent(username) + '/repos', null, function(repos) {
                    if (repos.length === 0) {
                        searchResults.innerHTML = '<div>No repositories found for this user.</div>';
                        return;
                    }
                    
                    var html = '<h3>' + username + '\'s Repositories</h3>';
                    repos.forEach(function(repo) {
                        html += '<div class="repo-item">' +
                                '<div class="repo-name"><a href="javascript:void(0)" onclick="editRepository(\'' + repo.owner.login + '\', \'' + repo.name + '\', true)">' + repo.name + '</a></div>' +
                                '<div class="repo-desc">' + (repo.description || 'No description') + '</div>' +
                                '<div>Stars: ' + repo.stargazers_count + ' | Forks: ' + repo.forks_count + '</div>' +
                                '</div>';
                    });
                    
                    searchResults.innerHTML = html;
                }, function(error) {
                    searchResults.innerHTML = '<div class="error">Failed to load repositories: ' + (error.message || 'Unknown error') + '</div>';
                });
            };
        });
    </script>
</body>
</html>
